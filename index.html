<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>图片防盗水印 (Image Watermarks)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    .conf {
        width: 300px;
        height: 95vh;
        position: fixed;
        top: 2.5vh;
        left: 0;
        background-color: #222;
        padding-top: 25vh;
        border-radius: 15px;
        text-align: center;
        color: white;
    }
    input {
        display: block;
        width: 200px;
        margin: 10px auto;
        padding: 10px;
        border-radius: 5px;
        border: 2px solid #333;
    }
    #canvas-container {
        margin-left: 320px;
        padding: 20px;
    }
    canvas {
        border: 1px solid #ddd;
    }
</style>
</head>
<body>
<div class="conf">
    <input id="setText" type="text" placeholder="水印文本 (Text)" />
    <input id="setColor" type="color" value="#999999" />
    <input id="setOpacity" type="range" min="0.1" max="1" step="0.1" value="1" />
    <input id="setWidth" type="number" value="300" placeholder="宽度 (Width)" />
    <button id="downloadBtn">下载图片 (Download)</button>
</div>
<div id="canvas-container">
    <canvas id="watermarkCanvas" width="500" height="500"></canvas>
</div>
<script>
    const canvas = document.getElementById('watermarkCanvas');
    const ctx = canvas.getContext('2d');
    const setText = document.getElementById('setText');
    const setColor = document.getElementById('setColor');
    const setOpacity = document.getElementById('setOpacity');
    const setWidth = document.getElementById('setWidth');
    const downloadBtn = document.getElementById('downloadBtn');

    let image = new Image();
    image.src = 'favicon.ico'; // 默认图片
    image.onload = () => drawCanvas();

    function drawCanvas() {
        // 清空画布
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 调整画布大小
        canvas.width = parseInt(setWidth.value) || 500;
        canvas.height = (canvas.width / image.width) * image.height;

        // 绘制图片
        ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

        // 添加水印
        if (setText.value) {
            ctx.globalAlpha = parseFloat(setOpacity.value);
            ctx.font = '20px Arial';
            ctx.fillStyle = setColor.value;

            const text = setText.value;
            const textWidth = ctx.measureText(text).width;
            const rows = Math.ceil(canvas.height / 50); // 水印行数
            const cols = Math.ceil(canvas.width / (textWidth + 20)); // 水印列数

            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    ctx.fillText(
                        text,
                        j * (textWidth + 20), // 水平方向
                        i * 50 + 25 // 垂直方向
                    );
                }
            }
            ctx.globalAlpha = 1.0;
        }
    }

    // 更新水印文字
    setText.addEventListener('input', drawCanvas);

    // 更新颜色
    setColor.addEventListener('input', drawCanvas);

    // 更新透明度
    setOpacity.addEventListener('input', drawCanvas);

    // 更新宽度
    setWidth.addEventListener('input', drawCanvas);

    // 下载图片
    downloadBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'watermarked-image.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    });

    // 支持拖放上传图片
    canvas.addEventListener('dragover', (e) => e.preventDefault());
    canvas.addEventListener('drop', (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = () => {
                image.src = reader.result;
                image.onload = drawCanvas;
            };
            reader.readAsDataURL(file);
        }
    });
</script>
</body>
</html>